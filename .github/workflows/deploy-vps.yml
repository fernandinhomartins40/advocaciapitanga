name: Deploy Advocacia Pitanga to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/vps_password
          chmod 600 ~/.ssh/vps_password

      - name: Sync code to VPS
        run: |
          # Instalar sshpass para autentica√ß√£o com senha
          sudo apt-get update && sudo apt-get install -y sshpass rsync

          # Criar diret√≥rio no VPS
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@72.60.10.112 "mkdir -p /root/advocaciapitanga"

          # Verificar estrutura do projeto antes do rsync
          echo "=== Verificando estrutura localmente antes do rsync ==="
          ls -la apps/backend/
          ls -la apps/frontend/

          # Sincronizar c√≥digo via rsync
          sshpass -f ~/.ssh/vps_password rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.next' \
            --exclude='*.db' \
            --exclude='*.db-*' \
            --exclude='apps/backend/uploads' \
            --exclude='.env' \
            --exclude='.env.local' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@72.60.10.112:/root/advocaciapitanga/

          # Verificar se c√≥digo foi copiado
          echo "=== Verificando estrutura na VPS ap√≥s rsync ==="
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@72.60.10.112 "ls -la /root/advocaciapitanga/apps/"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          host: 72.60.10.112
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 600s
          envs: OPENAI_API_KEY
          script: |
            set -e

            echo "=== Iniciando Deploy Advocacia Pitanga ==="

            # Diret√≥rio da aplica√ß√£o
            APP_DIR="/root/advocaciapitanga"

            # Parar containers existentes (SEM -v para preservar volumes)
            echo "Parando containers existentes..."
            cd $APP_DIR
            docker-compose -f docker-compose.vps.yml down || true

            # Verificar e garantir que volumes cr√≠ticos existam
            echo "=== Verificando volumes Docker ==="
            if ! docker volume ls | grep -q "advocaciapitanga.*postgres_data"; then
              echo "‚ö†Ô∏è Volume postgres_data n√£o existe, ser√° criado no pr√≥ximo docker-compose up"
            else
              echo "‚úì Volume postgres_data encontrado"
            fi

            echo "Verificando c√≥digo sincronizado..."
            ls -la

            # Criar arquivo .env
            echo "Criando arquivo .env..."
            cat > .env << 'EOF'
            # Node.js
            NODE_ENV=production

            # Application
            PORT=3001
            FRONTEND_PORT=3000

            # PostgreSQL
            POSTGRES_USER=advocacia
            POSTGRES_PASSWORD=advocacia2024secure
            POSTGRES_DB=advocacia_pitanga

            # Database URL
            DATABASE_URL=postgresql://advocacia:advocacia2024secure@postgres:5432/advocacia_pitanga

            # JWT
            JWT_SECRET=advocacia-pitanga-production-secret-$(date +%s)-$(openssl rand -hex 16)
            JWT_EXPIRES_IN=7d

            # OpenAI
            OPENAI_API_KEY=${OPENAI_API_KEY:-sua-chave-openai-aqui}

            # Frontend
            NEXT_PUBLIC_API_URL=https://advocaciapitanga.com.br/api

            # CORS
            CORS_ORIGIN=https://advocaciapitanga.com.br,https://www.advocaciapitanga.com.br

            # Container Limits
            CONTAINER_MEMORY_LIMIT=1g
            CONTAINER_CPU_LIMIT=2
            EOF

            # Adicionar BUILD_TIMESTAMP ao .env
            echo "BUILD_TIMESTAMP=$(date +%s)" >> .env

            # Limpar containers e imagens antigas (PRESERVAR volumes)
            echo "Limpando recursos antigos..."
            docker container prune -f || true
            docker image prune -af || true

            # Garantir BUILD_TIMESTAMP como vari√°vel de ambiente
            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            # ===== VALIDA√á√ÉO PR√â-BUILD =====
            echo "=== Validando estrutura do projeto antes do build ==="

            if [ ! -f "apps/backend/package.json" ]; then
              echo "‚ùå ERRO: apps/backend/package.json n√£o encontrado!"
              exit 1
            fi
            echo "‚úì backend/package.json encontrado"

            if [ ! -f "apps/frontend/package.json" ]; then
              echo "‚ùå ERRO: apps/frontend/package.json n√£o encontrado!"
              exit 1
            fi
            echo "‚úì frontend/package.json encontrado"

            if [ ! -d "packages/database" ]; then
              echo "‚ùå ERRO: diret√≥rio packages/database n√£o encontrado!"
              exit 1
            fi
            echo "‚úì Estrutura database encontrada"

            echo "=== Todos os arquivos cr√≠ticos validados ==="

            # Parar e remover containers antigos
            echo "Parando e removendo containers antigos (preservando volumes)..."
            docker-compose -f docker-compose.vps.yml down --remove-orphans || true

            # Remover imagens antigas
            echo "Removendo imagens antigas..."
            docker rmi advocaciapitanga-vps 2>/dev/null || true
            docker rmi $(docker images -q 'advocaciapitanga*') 2>/dev/null || true

            # Build da imagem Docker
            echo "Construindo imagem Docker..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull || { echo "‚ùå Erro ao construir imagem Docker"; exit 1; }
            echo "‚úÖ Imagem Docker constru√≠da com sucesso"

            # Iniciar containers
            echo "Iniciando containers..."
            docker-compose -f docker-compose.vps.yml up -d --remove-orphans || { echo "‚ùå Erro ao iniciar containers"; exit 1; }
            echo "‚úÖ Containers iniciados"

            # Aguardar containers iniciarem
            echo "Aguardando containers iniciarem..."
            sleep 20

            # Verificar status dos containers
            echo "=== Verificando status dos containers ==="
            docker-compose -f docker-compose.vps.yml ps

            # Verificar se containers est√£o rodando
            if ! docker ps | grep -q advocacia-vps; then
              echo "‚ùå Container advocacia-vps n√£o est√° rodando!"
              echo "=== Logs do container ==="
              docker logs advocacia-vps --tail=100
              exit 1
            fi
            echo "‚úì Container advocacia-vps est√° rodando"

            if ! docker ps | grep -q advocacia-postgres; then
              echo "‚ùå Container advocacia-postgres n√£o est√° rodando!"
              echo "=== Logs do PostgreSQL ==="
              docker logs advocacia-postgres --tail=50
              exit 1
            fi
            echo "‚úì Container advocacia-postgres est√° rodando"

            # Aguardar aplica√ß√£o inicializar
            echo "Aguardando aplica√ß√£o inicializar (20s)..."
            sleep 20

            # Executar migrations
            echo "=== Executando migrations ==="
            docker exec advocacia-vps sh -c "cd /app && npx prisma migrate deploy --schema=./packages/database/prisma/schema.prisma" || echo "‚ö†Ô∏è Migrations falharam"

            # ===== LOGS DE DIAGN√ìSTICO =====
            echo "=== Logs da Aplica√ß√£o (√∫ltimas 100 linhas) ==="
            docker logs advocacia-vps --tail=100

            # ===== CONFIGURAR NGINX =====
            echo "=== Configurando Nginx para porta 3190 ==="

            # Criar configura√ß√£o do Nginx
            cat > /etc/nginx/sites-available/advocaciapitanga.conf << 'NGINX_EOF'
            # HTTP - Advocacia Pitanga
            server {
                listen 80;
                listen [::]:80;

                server_name advocaciapitanga.com.br www.advocaciapitanga.com.br;

                # Redirecionar HTTP para HTTPS
                return 301 https://$server_name$request_uri;
            }

            # HTTPS - Advocacia Pitanga
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;

                server_name advocaciapitanga.com.br www.advocaciapitanga.com.br;

                # SSL Configuration (certbot ir√° adicionar certificados)
                # ssl_certificate e ssl_certificate_key ser√£o configurados pelo certbot

                # Logs
                access_log /var/log/nginx/advocaciapitanga-access.log;
                error_log /var/log/nginx/advocaciapitanga-error.log;

                # Limite de upload (para documentos)
                client_max_body_size 100M;
                client_body_timeout 600s;

                # API Backend
                location /api {
                    proxy_pass http://127.0.0.1:3190/api;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;

                    proxy_connect_timeout 300s;
                    proxy_send_timeout 300s;
                    proxy_read_timeout 300s;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:3190/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }

                # Frontend Next.js
                location / {
                    proxy_pass http://127.0.0.1:3190/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                # Next.js WebSocket (HMR - apenas para desenvolvimento)
                location /_next/webpack-hmr {
                    proxy_pass http://127.0.0.1:3190/_next/webpack-hmr;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }
            }
            NGINX_EOF

            # Habilitar site
            ln -sf /etc/nginx/sites-available/advocaciapitanga.conf /etc/nginx/sites-enabled/

            # Testar e recarregar Nginx
            nginx -t && systemctl reload nginx
            echo "‚úÖ Nginx configurado com sucesso na porta 3190"

            # Aguardar Nginx iniciar
            sleep 3

            # Verificar se est√° escutando nas portas
            echo "=== Verificando portas em uso ==="
            netstat -tulpn | grep nginx | grep ":80 " || echo "‚ö†Ô∏è Nginx n√£o encontrado na porta 80"
            netstat -tulpn | grep nginx | grep ":443 " || echo "‚ö†Ô∏è Nginx n√£o encontrado na porta 443"
            netstat -tulpn | grep node | grep ":3190 " || echo "‚ö†Ô∏è App n√£o encontrado na porta 3190"

            # ===== VERIFICAR HEALTH CHECK =====
            echo "=== Verificando health check ==="
            for i in {1..20}; do
              if curl -f http://localhost:3190/health 2>/dev/null; then
                echo "‚úÖ Advocacia Pitanga est√° rodando na porta 3190!"

                echo ""
                echo "=== Testando frontend porta 3190 ==="
                curl -I http://localhost:3190 2>/dev/null | head -5

                echo ""
                echo "=== Testando API ==="
                curl -I http://localhost:3190/api/health 2>/dev/null | head -5 || echo "‚ö†Ô∏è API health check n√£o dispon√≠vel"

                echo ""
                echo "‚úÖ Deploy conclu√≠do - aplica√ß√£o est√° rodando!"
                echo "üìç URLs:"
                echo "   - https://advocaciapitanga.com.br"
                echo "   - https://www.advocaciapitanga.com.br"
                echo "üìç Porta interna: 3190"
                echo "üì¶ Volumes persistentes:"
                echo "   - postgres_data: PostgreSQL database"

                echo ""
                echo "‚ö†Ô∏è IMPORTANTE: Configure SSL com certbot:"
                echo "   sudo certbot --nginx -d advocaciapitanga.com.br -d www.advocaciapitanga.com.br"

                exit 0
              fi
              echo "Tentativa $i/20 falhou, aguardando 10s..."

              # Mostrar logs a cada 4 tentativas
              if [ $((i % 4)) -eq 0 ]; then
                echo "=== Logs recentes ==="
                docker logs advocacia-vps --tail=30
              fi

              sleep 10
            done

            echo "‚ö†Ô∏è Health check falhou ap√≥s 20 tentativas"
            echo "Logs completos:"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "üåê Advocacia Pitanga dispon√≠vel em:"
          echo "   - https://advocaciapitanga.com.br"
          echo "   - https://www.advocaciapitanga.com.br"
          echo "üìä Health check: https://advocaciapitanga.com.br/health"
          echo "üê≥ Containers rodando:"
          echo "   - advocacia-vps (aplica√ß√£o)"
          echo "   - advocacia-postgres (banco de dados)"
          echo ""
          echo "‚ö†Ô∏è PR√ìXIMO PASSO: Configure SSL executando na VPS:"
          echo "   sudo certbot --nginx -d advocaciapitanga.com.br -d www.advocaciapitanga.com.br"
