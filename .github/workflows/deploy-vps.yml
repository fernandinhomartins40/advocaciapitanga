name: Deploy Advocacia Pitanga to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/vps_password
          chmod 600 ~/.ssh/vps_password

      - name: Sync code to VPS
        run: |
          # Instalar sshpass para autentica√ß√£o com senha
          sudo apt-get update && sudo apt-get install -y sshpass rsync

          # Criar diret√≥rio no VPS
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@72.60.10.112 "mkdir -p /root/advocaciapitanga"

          # Verificar estrutura do projeto antes do rsync
          echo "=== Verificando estrutura localmente antes do rsync ==="
          ls -la apps/backend/
          ls -la apps/frontend/

          # Sincronizar c√≥digo via rsync
          sshpass -f ~/.ssh/vps_password rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.next' \
            --exclude='*.db' \
            --exclude='*.db-*' \
            --exclude='apps/backend/uploads' \
            --exclude='.env' \
            --exclude='.env.local' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@72.60.10.112:/root/advocaciapitanga/

          # Verificar se c√≥digo foi copiado
          echo "=== Verificando estrutura na VPS ap√≥s rsync ==="
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@72.60.10.112 "ls -la /root/advocaciapitanga/apps/"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          host: 72.60.10.112
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 600s
          envs: OPENAI_API_KEY
          script: |
            set -e

            echo "=== Iniciando Deploy Advocacia Pitanga ==="

            # Diret√≥rio da aplica√ß√£o
            APP_DIR="/root/advocaciapitanga"

            # ===== PROTE√á√ÉO DE VOLUMES - VERIFICA√á√ÉO CR√çTICA =====
            echo "=== Verificando volumes Docker antes de qualquer opera√ß√£o ==="

            # Verificar se volumes de dados existem
            POSTGRES_VOLUME=$(docker volume ls -q | grep "postgres_data" || echo "")
            UPLOADS_VOLUME=$(docker volume ls -q | grep "uploads_data" || echo "")

            if [ -n "$POSTGRES_VOLUME" ]; then
              echo "‚úÖ Volume postgres_data encontrado: $POSTGRES_VOLUME"
              VOLUME_SIZE=$(docker volume inspect "$POSTGRES_VOLUME" 2>/dev/null | grep Mountpoint || echo "")
              echo "   Localiza√ß√£o: $VOLUME_SIZE"
            else
              echo "‚ÑπÔ∏è Volume postgres_data n√£o existe (ser√° criado no primeiro deploy)"
            fi

            if [ -n "$UPLOADS_VOLUME" ]; then
              echo "‚úÖ Volume uploads_data encontrado: $UPLOADS_VOLUME"
            else
              echo "‚ÑπÔ∏è Volume uploads_data n√£o existe (ser√° criado no primeiro deploy)"
            fi

            # Parar containers existentes (NUNCA usar -v que remove volumes!)
            echo ""
            echo "=== Parando containers (preservando volumes) ==="
            cd $APP_DIR
            docker-compose -f docker-compose.vps.yml down || true

            # Verifica√ß√£o de seguran√ßa: garantir que volumes N√ÉO foram removidos
            echo ""
            echo "=== Verifica√ß√£o de seguran√ßa p√≥s-parada ==="
            POSTGRES_VOLUME_AFTER=$(docker volume ls -q | grep "postgres_data" || echo "")

            if [ -n "$POSTGRES_VOLUME" ] && [ -z "$POSTGRES_VOLUME_AFTER" ]; then
              echo "‚ùå ERRO CR√çTICO: Volume postgres_data foi removido inadvertidamente!"
              echo "Este √© um erro grave que pode causar perda de dados."
              exit 1
            else
              echo "‚úÖ Volumes preservados com sucesso"
            fi

            echo "Verificando c√≥digo sincronizado..."
            ls -la

            # Criar arquivo .env
            echo "Criando arquivo .env..."
            cat > .env << 'EOF'
            # Node.js
            NODE_ENV=production

            # Application
            PORT=3001
            FRONTEND_PORT=3000

            # PostgreSQL
            POSTGRES_USER=advocacia
            POSTGRES_PASSWORD=advocacia2024secure
            POSTGRES_DB=advocacia_pitanga

            # Database URL
            DATABASE_URL=postgresql://advocacia:advocacia2024secure@postgres:5432/advocacia_pitanga

            # JWT
            JWT_SECRET=advocacia-pitanga-production-secret-$(date +%s)-$(openssl rand -hex 16)
            JWT_EXPIRES_IN=7d

            # OpenAI
            OPENAI_API_KEY=${OPENAI_API_KEY:-sua-chave-openai-aqui}

            # Frontend
            NEXT_PUBLIC_API_URL=https://advocaciapitanga.com.br/api

            # CORS
            CORS_ORIGIN=https://advocaciapitanga.com.br,https://www.advocaciapitanga.com.br

            # Container Limits
            CONTAINER_MEMORY_LIMIT=1g
            CONTAINER_CPU_LIMIT=2
            EOF

            # Adicionar BUILD_TIMESTAMP ao .env
            echo "BUILD_TIMESTAMP=$(date +%s)" >> .env

            # ===== LIMPEZA SEGURA (SEM TOCAR EM VOLUMES) =====
            echo "=== Limpando recursos antigos (containers e imagens apenas) ==="

            # Verificar volumes antes da limpeza
            VOLUMES_BEFORE=$(docker volume ls -q | grep -E "postgres_data|uploads_data" | wc -l)
            echo "üìä Volumes de dados antes da limpeza: $VOLUMES_BEFORE"

            # Limpar APENAS containers parados (NUNCA usar -v que remove volumes)
            echo "Removendo containers parados..."
            docker container prune -f || true

            # Limpar APENAS imagens n√£o utilizadas (volumes n√£o s√£o afetados)
            echo "Removendo imagens n√£o utilizadas..."
            docker image prune -af || true

            # IMPORTANTE: NUNCA executar docker volume prune em produ√ß√£o!
            # Isso removeria volumes √≥rf√£os que podem conter dados importantes

            # Verificar volumes ap√≥s limpeza
            VOLUMES_AFTER=$(docker volume ls -q | grep -E "postgres_data|uploads_data" | wc -l)
            echo "üìä Volumes de dados ap√≥s limpeza: $VOLUMES_AFTER"

            if [ "$VOLUMES_BEFORE" -ne "$VOLUMES_AFTER" ]; then
              echo "‚ùå ERRO CR√çTICO: Volumes foram removidos durante limpeza!"
              echo "Antes: $VOLUMES_BEFORE | Depois: $VOLUMES_AFTER"
              exit 1
            else
              echo "‚úÖ Limpeza conclu√≠da com seguran√ßa, volumes preservados"
            fi

            # Garantir BUILD_TIMESTAMP como vari√°vel de ambiente
            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            # ===== VALIDA√á√ÉO PR√â-BUILD =====
            echo "=== Validando estrutura do projeto antes do build ==="

            if [ ! -f "apps/backend/package.json" ]; then
              echo "‚ùå ERRO: apps/backend/package.json n√£o encontrado!"
              exit 1
            fi
            echo "‚úì backend/package.json encontrado"

            if [ ! -f "apps/frontend/package.json" ]; then
              echo "‚ùå ERRO: apps/frontend/package.json n√£o encontrado!"
              exit 1
            fi
            echo "‚úì frontend/package.json encontrado"

            if [ ! -d "packages/database" ]; then
              echo "‚ùå ERRO: diret√≥rio packages/database n√£o encontrado!"
              exit 1
            fi
            echo "‚úì Estrutura database encontrada"

            echo "=== Todos os arquivos cr√≠ticos validados ==="

            # Parar e remover containers antigos
            echo "Parando e removendo containers antigos (preservando volumes)..."
            docker-compose -f docker-compose.vps.yml down --remove-orphans || true

            # Remover imagens antigas
            echo "Removendo imagens antigas..."
            docker rmi advocaciapitanga-vps 2>/dev/null || true
            docker rmi $(docker images -q 'advocaciapitanga*') 2>/dev/null || true

            # Build da imagem Docker
            echo "Construindo imagem Docker..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull || { echo "‚ùå Erro ao construir imagem Docker"; exit 1; }
            echo "‚úÖ Imagem Docker constru√≠da com sucesso"

            # Iniciar containers
            echo "Iniciando containers..."
            docker-compose -f docker-compose.vps.yml up -d --remove-orphans || { echo "‚ùå Erro ao iniciar containers"; exit 1; }
            echo "‚úÖ Containers iniciados"

            # Aguardar containers iniciarem
            echo "Aguardando containers iniciarem..."
            sleep 20

            # Verificar status dos containers
            echo "=== Verificando status dos containers ==="
            docker-compose -f docker-compose.vps.yml ps

            # Verificar se containers est√£o rodando
            if ! docker ps | grep -q advocacia-vps; then
              echo "‚ùå Container advocacia-vps n√£o est√° rodando!"
              echo "=== Logs do container ==="
              docker logs advocacia-vps --tail=100
              exit 1
            fi
            echo "‚úì Container advocacia-vps est√° rodando"

            if ! docker ps | grep -q advocacia-postgres; then
              echo "‚ùå Container advocacia-postgres n√£o est√° rodando!"
              echo "=== Logs do PostgreSQL ==="
              docker logs advocacia-postgres --tail=50
              exit 1
            fi
            echo "‚úì Container advocacia-postgres est√° rodando"

            # Aguardar aplica√ß√£o inicializar
            echo "Aguardando aplica√ß√£o inicializar (20s)..."
            sleep 20

            # ===== BACKUP AUTOM√ÅTICO ANTES DE MIGRATIONS =====
            echo "=== Criando backup de seguran√ßa antes de migrations ==="
            if docker ps | grep -q advocacia-postgres; then
              # Verificar se banco tem dados
              TABLE_COUNT=$(docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';" 2>/dev/null | tr -d '[:space:]' || echo "0")

              if [ -n "$TABLE_COUNT" ] && [ "$TABLE_COUNT" -gt "0" ] 2>/dev/null; then
                echo "üìä Banco tem $TABLE_COUNT tabela(s), criando backup de seguran√ßa..."

                # Criar diret√≥rio de backups
                mkdir -p ${APP_DIR}/backups

                # Criar backup
                BACKUP_FILE="${APP_DIR}/backups/pre_deploy_$(date +%Y%m%d_%H%M%S).sql"
                docker exec advocacia-postgres pg_dump -U advocacia -d advocacia_pitanga --clean --if-exists > "$BACKUP_FILE"

                if [ -s "$BACKUP_FILE" ]; then
                  BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                  echo "‚úÖ Backup criado: $BACKUP_FILE ($BACKUP_SIZE)"

                  # MELHORIA 1: Validar integridade do backup
                  echo ""
                  echo "üîç Validando integridade do backup..."
                  if grep -q "CREATE TABLE\|INSERT INTO\|COPY" "$BACKUP_FILE"; then
                    echo "‚úÖ Backup cont√©m estrutura SQL v√°lida"

                    # Verificar se backup est√° completo
                    if tail -n 1 "$BACKUP_FILE" | grep -q "PostgreSQL database dump complete"; then
                      echo "‚úÖ Backup completo e √≠ntegro"
                    else
                      echo "‚ö†Ô∏è AVISO: Backup pode estar incompleto"
                    fi

                    # Verificar tamanho m√≠nimo
                    BACKUP_SIZE_BYTES=$(stat -c%s "$BACKUP_FILE" 2>/dev/null || echo "0")
                    if [ "$BACKUP_SIZE_BYTES" -gt 1024 ]; then
                      echo "‚úÖ Tamanho do backup adequado: $BACKUP_SIZE"
                    else
                      echo "‚ùå ERRO: Backup muito pequeno, abortando deploy"
                      exit 1
                    fi
                  else
                    echo "‚ùå ERRO: Backup n√£o cont√©m SQL v√°lido, abortando deploy"
                    exit 1
                  fi

                  ln -sf "$BACKUP_FILE" "${APP_DIR}/backups/latest.sql"

                  # MELHORIA 2: Enviar backup para local remoto (se configurado)
                  if [ -n "${AWS_S3_BUCKET:-}" ] || [ -n "${REMOTE_BACKUP_HOST:-}" ]; then
                    echo ""
                    echo "üì§ Enviando backup para local remoto..."
                    bash ${APP_DIR}/scripts/backup-remote.sh "$BACKUP_FILE" || echo "‚ö†Ô∏è AVISO: Backup remoto falhou, mas continuando..."
                  fi
                else
                  echo "‚ùå ERRO: Backup vazio ou falhou, abortando deploy"
                  exit 1
                fi
              else
                echo "‚ÑπÔ∏è Banco vazio, backup n√£o necess√°rio"
              fi
            fi

            # ===== SINCRONIZA√á√ÉO DO SCHEMA (APENAS MIGRATIONS) =====
            echo "=== Sincronizando schema do banco de dados ==="

            # SEMPRE usar migrate deploy (NUNCA db push em produ√ß√£o)
            if docker exec advocacia-vps sh -c "cd /app && ls packages/database/prisma/migrations 2>/dev/null" | grep -q "migration"; then
              echo "üì¶ Migrations encontradas, executando migrate deploy..."

              if docker exec advocacia-vps sh -c "cd /app && npx prisma migrate deploy --schema=./packages/database/prisma/schema.prisma"; then
                echo "‚úÖ Migrations aplicadas com sucesso"
              else
                echo "‚ùå ERRO: Migrate deploy falhou!"

                # MELHORIA 3: Notificar falha
                bash ${APP_DIR}/scripts/notify.sh \
                  "Deploy Falhou - Migrations" \
                  "Erro ao aplicar migrations. Iniciando rollback autom√°tico..." \
                  "error" || true

                echo "üîÑ Tentando restaurar backup..."

                if [ -f "${APP_DIR}/backups/latest.sql" ]; then
                  if docker exec -i advocacia-postgres psql -U advocacia -d advocacia_pitanga < "${APP_DIR}/backups/latest.sql"; then
                    echo "‚úÖ Backup restaurado, rollback completo"

                    # Notificar sucesso do rollback
                    bash ${APP_DIR}/scripts/notify.sh \
                      "Rollback Conclu√≠do" \
                      "Backup restaurado com sucesso ap√≥s falha nas migrations" \
                      "warning" || true
                  else
                    echo "‚ùå ERRO CR√çTICO: Falha ao restaurar backup!"

                    # Notificar falha cr√≠tica
                    bash ${APP_DIR}/scripts/notify.sh \
                      "ERRO CR√çTICO - Deploy Falhou" \
                      "Migrations falharam E backup n√£o p√¥de ser restaurado. INTERVEN√á√ÉO MANUAL NECESS√ÅRIA!" \
                      "error" || true
                  fi
                else
                  echo "‚ùå ERRO: Backup n√£o encontrado para restaura√ß√£o!"

                  # Notificar falta de backup
                  bash ${APP_DIR}/scripts/notify.sh \
                    "ERRO CR√çTICO - Sem Backup" \
                    "Migrations falharam e nenhum backup foi encontrado. INTERVEN√á√ÉO MANUAL NECESS√ÅRIA!" \
                    "error" || true
                fi

                docker logs advocacia-vps --tail=50
                exit 1
              fi
            else
              echo "‚ö†Ô∏è AVISO: Nenhuma migration encontrada!"
              echo "‚ùå ERRO: Deploy em produ√ß√£o REQUER migrations versionadas"
              echo ""
              echo "Para criar migrations, execute localmente:"
              echo "  cd packages/database"
              echo "  npx prisma migrate dev --name nome_da_migration"
              echo "  git add prisma/migrations"
              echo "  git commit -m 'feat: add migration'"
              echo ""
              exit 1
            fi

            # Verificar se tabelas foram criadas usando o psql
            echo "=== Validando cria√ß√£o de tabelas ==="
            TABLE_COUNT=$(docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';" 2>/dev/null | tr -d '[:space:]' || echo "0")

            echo "DEBUG: TABLE_COUNT='$TABLE_COUNT'"

            if [ -n "$TABLE_COUNT" ] && [ "$TABLE_COUNT" -gt "0" ] 2>/dev/null; then
              echo "‚úÖ Validado: $TABLE_COUNT tabela(s) criada(s) no banco"
            else
              echo "‚ö†Ô∏è N√£o foi poss√≠vel validar tabelas via SQL, tentando m√©todo alternativo..."
              # Verificar se pelo menos uma tabela User existe
              if docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -c "\dt" 2>/dev/null | grep -q "User"; then
                echo "‚úÖ Tabela User encontrada, schema aplicado com sucesso"
              else
                echo "‚ùå ERRO: Nenhuma tabela encontrada ap√≥s sincroniza√ß√£o!"
                echo "=== Listando tabelas ==="
                docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -c "\dt"
                exit 1
              fi
            fi

            # Verificar se seed j√° foi executado (verificar se existe usu√°rio admin)
            echo "=== Verificando necessidade de executar seed ==="
            ADMIN_EXISTS=$(docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -t -c "SELECT COUNT(*) FROM \"User\" WHERE email = 'admin@pitanga.com';" 2>/dev/null | tr -d '[:space:]' || echo "0")

            echo "DEBUG: ADMIN_EXISTS='$ADMIN_EXISTS'"

            if [ "$ADMIN_EXISTS" = "0" ] || [ -z "$ADMIN_EXISTS" ]; then
              echo "üì¶ Banco de dados vazio, executando seed..."

              # Executar seed usando prisma db seed
              if docker exec advocacia-vps sh -c "cd /app/packages/database && npx prisma db seed"; then
                echo "‚úÖ Seed executado com sucesso!"

                # Validar que usu√°rio foi criado
                echo "=== Validando cria√ß√£o de usu√°rios ==="
                USER_COUNT=$(docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -t -c "SELECT COUNT(*) FROM \"User\";" 2>/dev/null | tr -d '[:space:]' || echo "0")

                echo "DEBUG: USER_COUNT='$USER_COUNT'"

                if [ -n "$USER_COUNT" ] && [ "$USER_COUNT" -gt "0" ] 2>/dev/null; then
                  echo "‚úÖ Validado: $USER_COUNT usu√°rio(s) criado(s) no banco"

                  # Listar usu√°rios criados
                  echo "=== Usu√°rios criados ==="
                  docker exec advocacia-postgres psql -U advocacia -d advocacia_pitanga -c "SELECT email, role, nome FROM \"User\";"
                else
                  echo "‚ö†Ô∏è AVISO: Nenhum usu√°rio encontrado ap√≥s seed"
                fi
              else
                echo "‚ùå ERRO: Seed falhou!"
                echo "=== Tentando m√©todo alternativo (execu√ß√£o direta) ==="
                if docker exec advocacia-vps sh -c "cd /app && npx tsx packages/database/prisma/seed.ts"; then
                  echo "‚úÖ Seed executado com m√©todo alternativo"
                else
                  echo "‚ùå ERRO CR√çTICO: Seed falhou em ambos m√©todos!"
                  docker logs advocacia-vps --tail=100
                  exit 1
                fi
              fi
            else
              echo "‚úì Seed j√° foi executado anteriormente (usu√°rio admin existe)"
              echo "‚ÑπÔ∏è Para reexecutar o seed, limpe o banco de dados manualmente"
            fi

            # ===== LOGS DE DIAGN√ìSTICO =====
            echo "=== Logs da Aplica√ß√£o (√∫ltimas 100 linhas) ==="
            docker logs advocacia-vps --tail=100

            # ===== CONFIGURAR NGINX =====
            echo "=== Configurando Nginx para porta 3190 ==="

            # Criar configura√ß√£o do Nginx
            cat > /etc/nginx/sites-available/advocaciapitanga.conf << 'NGINX_EOF'
            # HTTP - Advocacia Pitanga
            server {
                listen 80;
                listen [::]:80;

                server_name advocaciapitanga.com.br www.advocaciapitanga.com.br;

                # Redirecionar HTTP para HTTPS
                return 301 https://$server_name$request_uri;
            }

            # HTTPS - Advocacia Pitanga
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;

                server_name advocaciapitanga.com.br www.advocaciapitanga.com.br;

                # SSL Configuration (certbot ir√° adicionar certificados)
                # ssl_certificate e ssl_certificate_key ser√£o configurados pelo certbot

                # Logs
                access_log /var/log/nginx/advocaciapitanga-access.log;
                error_log /var/log/nginx/advocaciapitanga-error.log;

                # Limite de upload (para documentos)
                client_max_body_size 100M;
                client_body_timeout 600s;

                # API Backend
                location /api {
                    proxy_pass http://127.0.0.1:3190/api;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;

                    proxy_connect_timeout 300s;
                    proxy_send_timeout 300s;
                    proxy_read_timeout 300s;
                }

                # Health check
                location /health {
                    proxy_pass http://127.0.0.1:3190/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }

                # Frontend Next.js
                location / {
                    proxy_pass http://127.0.0.1:3190/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                # Next.js WebSocket (HMR - apenas para desenvolvimento)
                location /_next/webpack-hmr {
                    proxy_pass http://127.0.0.1:3190/_next/webpack-hmr;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }
            }
            NGINX_EOF

            # Habilitar site
            ln -sf /etc/nginx/sites-available/advocaciapitanga.conf /etc/nginx/sites-enabled/

            # Testar e recarregar Nginx
            nginx -t && systemctl reload nginx
            echo "‚úÖ Nginx configurado com sucesso na porta 3190"

            # Aguardar Nginx iniciar
            sleep 3

            # Verificar se est√° escutando nas portas
            echo "=== Verificando portas em uso ==="
            netstat -tulpn | grep nginx | grep ":80 " || echo "‚ö†Ô∏è Nginx n√£o encontrado na porta 80"
            netstat -tulpn | grep nginx | grep ":443 " || echo "‚ö†Ô∏è Nginx n√£o encontrado na porta 443"
            netstat -tulpn | grep node | grep ":3190 " || echo "‚ö†Ô∏è App n√£o encontrado na porta 3190"

            # ===== VERIFICAR HEALTH CHECK =====
            echo "=== Verificando health check ==="
            for i in {1..20}; do
              if curl -f http://localhost:3190/health 2>/dev/null; then
                echo "‚úÖ Advocacia Pitanga est√° rodando na porta 3190!"

                echo ""
                echo "=== Testando frontend porta 3190 ==="
                curl -I http://localhost:3190 2>/dev/null | head -5

                echo ""
                echo "=== Testando API ==="
                curl -I http://localhost:3190/api/health 2>/dev/null | head -5 || echo "‚ö†Ô∏è API health check n√£o dispon√≠vel"

                echo ""
                echo "‚úÖ Deploy conclu√≠do - aplica√ß√£o est√° rodando!"
                echo "üìç URLs:"
                echo "   - https://advocaciapitanga.com.br"
                echo "   - https://www.advocaciapitanga.com.br"
                echo "üìç Porta interna: 3190"
                echo "üì¶ Volumes persistentes:"
                echo "   - postgres_data: PostgreSQL database"

                echo ""
                echo "‚ö†Ô∏è IMPORTANTE: Configure SSL com certbot:"
                echo "   sudo certbot --nginx -d advocaciapitanga.com.br -d www.advocaciapitanga.com.br"

                # MELHORIA 3: Notificar sucesso do deploy
                bash ${APP_DIR}/scripts/notify.sh \
                  "Deploy Conclu√≠do com Sucesso ‚úÖ" \
                  "Advocacia Pitanga foi atualizado e est√° rodando em https://advocaciapitanga.com.br" \
                  "success" || true

                exit 0
              fi
              echo "Tentativa $i/20 falhou, aguardando 10s..."

              # Mostrar logs a cada 4 tentativas
              if [ $((i % 4)) -eq 0 ]; then
                echo "=== Logs recentes ==="
                docker logs advocacia-vps --tail=30
              fi

              sleep 10
            done

            echo "‚ö†Ô∏è Health check falhou ap√≥s 20 tentativas"
            echo "Logs completos:"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "üåê Advocacia Pitanga dispon√≠vel em:"
          echo "   - https://advocaciapitanga.com.br"
          echo "   - https://www.advocaciapitanga.com.br"
          echo "üìä Health check: https://advocaciapitanga.com.br/health"
          echo "üê≥ Containers rodando:"
          echo "   - advocacia-vps (aplica√ß√£o)"
          echo "   - advocacia-postgres (banco de dados)"
          echo ""
          echo "‚ö†Ô∏è PR√ìXIMO PASSO: Configure SSL executando na VPS:"
          echo "   sudo certbot --nginx -d advocaciapitanga.com.br -d www.advocaciapitanga.com.br"
